---
title: "MCMC output format"
date: "2023-03-20"
vignette: >
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
  %\VignetteIndexEntry{MCMC output format}
output:
  rmarkdown::html_vignette
---



In this tutorial, we will have a closer look at the object returned by calling `run_mcmc()` on a network model. Understanding the structure of the object containing the results of a run is important for model diagnostics and interpretation.

## The default format: mcmc.list

To quickly obtain an MCMC run output for us to examine, let's run the simple model `aquarium_mod` which is provided with the package. Feel free to read the help `?aquarium_mod` if you are curious about the model itself.


```r
library(isotracer)
aquarium_mod
fit <- run_mcmc(aquarium_mod, iter = 1000)
```



By default, `run_mcmc()` returns an `mcmc.list` object. An `mcmc.list` has a simple format to store the content of parallel MCMC chains:


```r
length(fit)
```

```
## [1] 4
```

```r
str(fit[[1]])
```

```
##  'mcmc' num [1:500, 1:8] 0.1475 0.0681 0.1006 0.1238 0.0935 ...
##  - attr(*, "dimnames")=List of 2
##   ..$ : NULL
##   ..$ : chr [1:8] "eta" "lambda_algae" "lambda_daphnia" "lambda_NH4" ...
##  - attr(*, "mcpar")= num [1:3] 501 1000 1
```

The output above can seem a little obscure if you are not familiar with R data structures, but in a nutshell it tells us that the `mcmc.list` is basically a list with one element per chain, each chain being stored as a matrix.

The `mcmc.list` class is implemented by the [coda](https://cran.r-project.org/package=coda) package, and it has the advantage of being recognized by many other R packages dealing with Bayesian MCMC such as **bayesplot** of **ggmcmc**.

In the **isotracer** package, the returned `fit` is very slightly extended compared to the base `mcmc.list` class:


```r
class(fit)
```

```
## [1] "networkModelStanfit" "mcmc.list"
```

By having also a `networkModelStanfit` class, the output from `run_mcmc()` can be recognized automatically by some methods implemented in **isotracer**, such as `plot()`:


```r
plot(fit)
# Note: the figure below only shows a few of the traceplots for vignette concision
```

<img src="figures/z-fig-080-unnamed-chunk-7-1.jpeg" alt="plot of chunk unnamed-chunk-7" style="display: block; margin: auto;" />

### How to convert the default output to a table?

An `mcmc.list` object can be converted to an even simpler, flat matrix:


```r
z <- as.matrix(fit)
head(z)
```

```
##             eta lambda_algae lambda_daphnia  lambda_NH4 upsilon_algae_to_daphnia
## [1,] 0.14747562   0.08213138     0.04353004 0.113521173               0.08032391
## [2,] 0.06810369   0.02578456     0.02359698 0.048480490               0.06168268
## [3,] 0.10061308   0.13294635     0.01102134 0.051578791               0.06745320
## [4,] 0.12378628   0.10140887     0.02580178 0.004820604               0.08860300
## [5,] 0.09349298   0.05500333     0.03043357 0.005857170               0.07315180
## [6,] 0.08644272   0.06491375     0.03644750 0.013300072               0.06001513
##      upsilon_daphnia_to_NH4 upsilon_NH4_to_algae      zeta
## [1,]             0.04699916            0.3581672 0.3923834
## [2,]             0.04858629            0.3617779 0.2592274
## [3,]             0.04839278            0.3554945 0.2649492
## [4,]             0.05009530            0.3236927 0.3100975
## [5,]             0.04911742            0.3063960 0.3250837
## [6,]             0.05730615            0.3530526 0.3568238
```

```r
str(z)
```

```
##  num [1:2000, 1:8] 0.1475 0.0681 0.1006 0.1238 0.0935 ...
##  - attr(*, "dimnames")=List of 2
##   ..$ : NULL
##   ..$ : chr [1:8] "eta" "lambda_algae" "lambda_daphnia" "lambda_NH4" ...
```

or to a data frame:


```r
z <- as.data.frame(as.matrix(fit))
head(z)
```

```
##          eta lambda_algae lambda_daphnia  lambda_NH4 upsilon_algae_to_daphnia
## 1 0.14747562   0.08213138     0.04353004 0.113521173               0.08032391
## 2 0.06810369   0.02578456     0.02359698 0.048480490               0.06168268
## 3 0.10061308   0.13294635     0.01102134 0.051578791               0.06745320
## 4 0.12378628   0.10140887     0.02580178 0.004820604               0.08860300
## 5 0.09349298   0.05500333     0.03043357 0.005857170               0.07315180
## 6 0.08644272   0.06491375     0.03644750 0.013300072               0.06001513
##   upsilon_daphnia_to_NH4 upsilon_NH4_to_algae      zeta
## 1             0.04699916            0.3581672 0.3923834
## 2             0.04858629            0.3617779 0.2592274
## 3             0.04839278            0.3554945 0.2649492
## 4             0.05009530            0.3236927 0.3100975
## 5             0.04911742            0.3063960 0.3250837
## 6             0.05730615            0.3530526 0.3568238
```

```r
str(z)
```

```
## 'data.frame':	2000 obs. of  8 variables:
##  $ eta                     : num  0.1475 0.0681 0.1006 0.1238 0.0935 ...
##  $ lambda_algae            : num  0.0821 0.0258 0.1329 0.1014 0.055 ...
##  $ lambda_daphnia          : num  0.0435 0.0236 0.011 0.0258 0.0304 ...
##  $ lambda_NH4              : num  0.11352 0.04848 0.05158 0.00482 0.00586 ...
##  $ upsilon_algae_to_daphnia: num  0.0803 0.0617 0.0675 0.0886 0.0732 ...
##  $ upsilon_daphnia_to_NH4  : num  0.047 0.0486 0.0484 0.0501 0.0491 ...
##  $ upsilon_NH4_to_algae    : num  0.358 0.362 0.355 0.324 0.306 ...
##  $ zeta                    : num  0.392 0.259 0.265 0.31 0.325 ...
```

or to a tibble:


```r
z <- tibble::as_tibble(as.matrix(fit))
z
```

```
## # A tibble: 2,000 × 8
##       eta lambda_algae lambda_daphnia lambda_NH4 upsilon_alga…¹ upsil…² upsil…³  zeta
##     <dbl>        <dbl>          <dbl>      <dbl>          <dbl>   <dbl>   <dbl> <dbl>
##  1 0.147        0.0821         0.0435    0.114           0.0803  0.0470   0.358 0.392
##  2 0.0681       0.0258         0.0236    0.0485          0.0617  0.0486   0.362 0.259
##  3 0.101        0.133          0.0110    0.0516          0.0675  0.0484   0.355 0.265
##  4 0.124        0.101          0.0258    0.00482         0.0886  0.0501   0.324 0.310
##  5 0.0935       0.0550         0.0304    0.00586         0.0732  0.0491   0.306 0.325
##  6 0.0864       0.0649         0.0364    0.0133          0.0600  0.0573   0.353 0.357
##  7 0.0739       0.0137         0.0506    0.0376          0.0569  0.0517   0.353 0.316
##  8 0.0685       0.0124         0.0369    0.0367          0.0639  0.0494   0.346 0.323
##  9 0.182        0.0396         0.0569    0.0492          0.0752  0.0520   0.330 0.315
## 10 0.174        0.0685         0.0282    0.145           0.0641  0.0478   0.332 0.457
## # … with 1,990 more rows, and abbreviated variable names ¹​upsilon_algae_to_daphnia,
## #   ²​upsilon_daphnia_to_NH4, ³​upsilon_NH4_to_algae
```

### How to calculate derived parameters?

Converting your output to one of those simple tabular formats can be useful if you want to manipulate and perform operations on your MCMC samples.

However, for simple manipulations, `isotracer` provides convenient methods to perform calculations on parameter chains directly from the output of `run_mcmc()`. You can thus produce derived parameter chains directly from the `mcmc.list` object, without having to convert your output to another format:


```r
algal_total_out <- fit[, "upsilon_algae_to_daphnia"] + fit[, "lambda_algae"]
algal_turnover <- 1 / algal_total_out
plot(algal_turnover)
```

<img src="figures/z-fig-080-unnamed-chunk-11-1.jpeg" alt="plot of chunk unnamed-chunk-11" style="display: block; margin: auto;" />

You can read more about this in the vignette about [calculating derived parameters](tutorial-110-derived-parameters.html).

### How to combine derived parameters?

You can combine derived parameters into a single `mcmc.list`object using the usual `c()` syntax. This can be convenient for more compact plotting or summary calculations:


```r
my_derived <- c("out rate" = algal_total_out, "turnover" = algal_turnover)
plot(my_derived)
```

<img src="figures/z-fig-080-unnamed-chunk-12-1.jpeg" alt="plot of chunk unnamed-chunk-12" style="display: block; margin: auto;" />

```r
summary(my_derived)
```

```
## 
## Iterations = 501:1000
## Thinning interval = 1 
## Number of chains = 4 
## Sample size per chain = 500 
## 
## 1. Empirical mean and standard deviation for each variable,
##    plus standard error of the mean:
## 
##            Mean      SD Naive SE Time-series SE
## out rate 0.1705 0.05756 0.001287       0.001803
## turnover 6.6573 2.63166 0.058846       0.084195
## 
## 2. Quantiles for each variable:
## 
##             2.5%    25%    50%    75%   97.5%
## out rate 0.07378 0.1281 0.1668 0.2071  0.2885
## turnover 3.46631 4.8297 5.9963 7.8043 13.5532
```

## A more detailed format: stanfit

Calling `run_mcmc()` will run a Stan model behind the scenes. Stan is great since it will let you know loudly when something went wrong with the run, such as problems with divergent chains or low Bayesian fraction of missing information. **Such problems should not be ignored!** The Stan development team has a [nice page explaining Stan's warnings](https://mc-stan.org/misc/warnings.html).

In any case, if something went wrong with your run, you might want to have a more complete output than simply the `mcmc.list` object. You can ask `run_mcmc()` to return the original `stanfit` object produced by Stan with:


```r
fit2 <- run_mcmc(aquarium_mod, iter = 1000, stanfit = TRUE)
```



`fit2` is now a regular `stanfit` object:


```r
class(fit2)
```

```
## [1] "stanfit"
## attr(,"package")
## [1] "rstan"
```

This is a more complicated type of object than an `mcmc.list`, but it also contains much more information about the Stan run. It also comes with the benefit of the existing methods for `stanfit` object, for example:


```r
rstan::plot(fit2)
```

<img src="figures/z-fig-080-unnamed-chunk-16-1.jpeg" alt="plot of chunk unnamed-chunk-16" style="display: block; margin: auto;" />

You can go through [Stan documentation](https://mc-stan.org/rstan/reference/stanfit-class.html) for more details about this format. If you are reading about solving Stan model issues on online forums and the suggested solutions require to examine some Stan output, that's the object you want to look at!

For example, you can examine it with ShinyStan:


```r
library(shinystan)
launch_shinystan(fit2)
```

<div class="alert-primary" role="alert"> 

Note that with the current version of **isotracer** the parameters are indexed but not named in the `stanfit` object. That is something that will probably be improved in the future!

</div>

<nav aria-label="Page navigation">
 <ul class="pagination justify-content-end">
  <li class="page-item"><a class="page-link" href="tutorial-060-units-priors.html">Previous: Units and priors</a></li>
  <li class="page-item"><a class="page-link" href="tutorial-090-post-run-analyses.html">Next: Post-run diagnostics and analyses</a></li>
 </ul>
</nav>
